# Railway Database Setup Guide

Este documento describe la configuraci√≥n de la base de datos PostgreSQL en Railway para el proyecto "El Sabor Colombiano".

## Estructura de la Base de Datos

### Tabla: productos
Almacena el cat√°logo de productos disponibles en la cafeter√≠a.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | SERIAL PRIMARY KEY | Identificador √∫nico del producto |
| nombre | VARCHAR(120) | Nombre del producto |
| categoria | VARCHAR(20) | Categor√≠a (comida/bebida) |
| descripcion | TEXT | Descripci√≥n detallada |
| precio | NUMERIC(10,2) | Precio en pesos colombianos |
| stock | INT | Cantidad disponible |
| promocion | BOOLEAN | Si est√° en promoci√≥n |
| imagen_url | TEXT | URL de la imagen |

### Tabla: pedidos
Almacena los pedidos realizados por los clientes.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | SERIAL PRIMARY KEY | Identificador √∫nico del pedido |
| cliente | VARCHAR(120) | Nombre del cliente |
| estado | VARCHAR(20) | Estado del pedido (pendiente/preparacion/listo/entregado/cancelado) |
| total | NUMERIC(10,2) | Total del pedido |
| created_at | TIMESTAMP | Fecha y hora de creaci√≥n |

### Tabla: detalle_pedido
Almacena los items de cada pedido.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | SERIAL PRIMARY KEY | Identificador √∫nico |
| pedido_id | INT | Referencia al pedido |
| producto_id | INT | Referencia al producto |
| cantidad | INT | Cantidad solicitada |
| precio_unitario | NUMERIC(10,2) | Precio al momento del pedido |
| subtotal | NUMERIC(10,2) | Total del item |

### Tabla: usuarios
Almacena los usuarios del sistema (administradores, meseros, clientes).

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | SERIAL PRIMARY KEY | Identificador √∫nico |
| nombre | VARCHAR(100) | Nombre completo |
| email | VARCHAR(120) UNIQUE | Email (usado para login) |
| contrasena_hash | VARCHAR(255) | Contrase√±a hasheada con bcrypt |
| rol | VARCHAR(20) | Rol (admin/mesero/cocina/cliente) |
| created_at | TIMESTAMP | Fecha de creaci√≥n |

## Configuraci√≥n en Railway

### Conexi√≥n a PostgreSQL

Railway proporciona dos URLs de conexi√≥n:

#### 1. URL Privada (para la aplicaci√≥n en Railway)
```
postgres.railway.internal:5432
```
- Usada por el backend cuando se ejecuta en Railway
- No requiere puerto p√∫blico
- Mayor seguridad y rendimiento

#### 2. URL P√∫blica (para conexiones externas)
```
switchyard.proxy.rlwy.net:32092
```
- Usada desde tu computadora local
- Permite conectar con herramientas como pgAdmin, psql, DBeaver
- Requiere SSL

### Variables de Entorno

Railway configura autom√°ticamente estas variables:

```bash
# Generadas autom√°ticamente por Railway
DATABASE_URL=postgresql://postgres:PASSWORD@postgres.railway.internal:5432/railway
DB_HOST=postgres.railway.internal
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=<auto-generated>
DB_NAME=railway

# Variables adicionales requeridas
NODE_ENV=production
JWT_SECRET=<tu-secret-seguro>
FRONTEND_URL=https://tu-app.up.railway.app
```

## Inicializaci√≥n Autom√°tica

El proyecto incluye un script de inicializaci√≥n autom√°tica que:

1. **Crea el esquema** de la base de datos (tablas, √≠ndices)
2. **Verifica si existen datos** antes de insertar
3. **Inserta datos iniciales** (productos y usuarios) si la base est√° vac√≠a
4. **Muestra un resumen** del estado de la base de datos

### Ejecuci√≥n Autom√°tica

El script se ejecuta autom√°ticamente en cada despliegue de Railway:

```json
// railway.json
{
  "deploy": {
    "startCommand": "cd backend && npm run init-db && cd .. && npm run start"
  }
}
```

### Ejecuci√≥n Manual

Si necesitas ejecutar el script manualmente:

```bash
# Usando Railway CLI
railway run npm run init-db

# O localmente (aseg√∫rate de tener las variables de entorno correctas)
cd backend
npm run init-db
```

## Datos Iniciales (Seed)

### Productos (14 items)

**Comidas (6):**
- Papas rellenas - $4,500
- Empanada de pollo - $2,000 (en promoci√≥n)
- Empanada de carne - $2,000
- Empanada ranchera - $2,200
- Arepa de carne - $5,000
- Arepa de queso - $4,500 (en promoci√≥n)

**Bebidas (8):**
- Avena - $3,000
- Jugo de mora - $3,500
- Jugo de guan√°bana - $4,000
- Jugo de tomate de √°rbol - $3,500
- Jugo de guayaba - $3,500 (en promoci√≥n)
- Caf√© - $2,500
- Caf√© con leche - $3,000
- Chocolate - $3,000

### Usuarios Iniciales

| Email | Contrase√±a | Rol |
|-------|-----------|-----|
| admin@elsaborcolombiano.com | admin123 | admin |
| mesero@elsaborcolombiano.com | mesero123 | mesero |

‚ö†Ô∏è **SEGURIDAD CR√çTICA**: 
- Estas son credenciales por defecto con contrase√±as d√©biles
- **DEBEN cambiarse INMEDIATAMENTE** despu√©s del primer despliegue
- Usa el endpoint `/api/usuarios/:id` con autenticaci√≥n de administrador
- Las contrase√±as deben tener m√≠nimo 12 caracteres con letras, n√∫meros y s√≠mbolos
- Considera implementar cambio de contrase√±a obligatorio en el primer inicio de sesi√≥n

## Conexi√≥n desde tu PC

### Usando psql

```bash
# Con variables individuales
psql -h switchyard.proxy.rlwy.net -p 32092 -U postgres -d railway

# Con URL completa
psql "postgresql://postgres:PASSWORD@switchyard.proxy.rlwy.net:32092/railway?sslmode=require"
```

### Usando DBeaver o pgAdmin

**Configuraci√≥n:**
- Host: `switchyard.proxy.rlwy.net`
- Puerto: `32092`
- Usuario: `postgres`
- Contrase√±a: `<tu-password-de-railway>`
- Base de datos: `railway`
- SSL: **Habilitado** (requerido)

## Verificaci√≥n del Estado

### Endpoint de Salud de la Base de Datos

```bash
# Verificar conexi√≥n
curl https://tu-app.up.railway.app/api/test-db

# Respuesta esperada:
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "stats": {
    "products": 14,
    "users": 2,
    "orders": 0
  }
}
```

### Verificar en los Logs de Railway

1. Ve a tu proyecto en Railway
2. Selecciona el servicio de la aplicaci√≥n
3. Ve a "Deployments"
4. Haz clic en el √∫ltimo deployment
5. Revisa los logs para ver:
   - ‚úÖ Conexi√≥n exitosa con PostgreSQL
   - üìã Esquema creado exitosamente
   - üì¶ Productos insertados
   - üë• Usuarios insertados

## Mantenimiento

### Respaldar la Base de Datos

```bash
# Usando Railway CLI
railway run pg_dump > backup.sql

# O directamente con pg_dump
pg_dump -h switchyard.proxy.rlwy.net -p 32092 -U postgres -d railway > backup.sql
```

### Restaurar desde Respaldo

```bash
# Usando Railway CLI
railway run psql < backup.sql

# O directamente
psql -h switchyard.proxy.rlwy.net -p 32092 -U postgres -d railway < backup.sql
```

### Limpiar y Repoblar Datos

```bash
# Este comando borra TODOS los datos y los reinserta
railway run npm run seed
```

‚ö†Ô∏è **CUIDADO**: El comando `seed` elimina todos los datos existentes.

## Actualizaciones Autom√°ticas

Railway gestiona autom√°ticamente las actualizaciones del contenedor PostgreSQL:

- **Imagen**: `ghcr.io/railwayapp-templates/postgres-ssl:17`
- **Auto-updates**: Configurado para aplicar actualizaciones de seguridad
- **SSL**: Siempre habilitado para mayor seguridad

Las actualizaciones menores se aplican autom√°ticamente sin downtime. Las actualizaciones mayores requieren aprobaci√≥n manual.

## Troubleshooting

### Error: "relation 'productos' does not exist"

**Soluci√≥n**: El esquema no se ha creado. Ejecuta:
```bash
railway run npm run init-db
```

### Error: "password authentication failed"

**Soluci√≥n**: Verifica que est√°s usando la contrase√±a correcta de Railway:
1. Ve a tu proyecto en Railway
2. Selecciona el servicio PostgreSQL
3. Ve a "Variables"
4. Copia el valor de `POSTGRES_PASSWORD`

### Los productos no aparecen en el frontend

**Pasos de diagn√≥stico:**
1. Verifica el endpoint: `https://tu-app.up.railway.app/api/productos`
2. Revisa los logs de Railway
3. Ejecuta: `railway run npm run init-db`
4. Verifica el endpoint nuevamente

### Error de conexi√≥n SSL

**Soluci√≥n**: Aseg√∫rate de que la conexi√≥n use SSL:
- En la URL de conexi√≥n: agrega `?sslmode=require`
- En el c√≥digo: `ssl: { rejectUnauthorized: false }`

## Seguridad

### Mejores Pr√°cticas

1. ‚úÖ **Usar variables de entorno** para credenciales
2. ‚úÖ **Habilitar SSL** en todas las conexiones
3. ‚úÖ **Cambiar contrase√±as por defecto** inmediatamente
4. ‚úÖ **Usar JWT_SECRET fuerte** (m√≠nimo 32 caracteres aleatorios)
5. ‚úÖ **Limitar acceso p√∫blico** a la base de datos (solo Railway CLI o IP fija)
6. ‚úÖ **Hacer respaldos regulares** de los datos

### Rotar Contrase√±as

Para cambiar la contrase√±a de un usuario desde la aplicaci√≥n:

```bash
# Usando el endpoint de actualizaci√≥n de usuario (requiere token de admin)
curl -X PUT https://tu-app.up.railway.app/api/usuarios/1 \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"contrasena": "nueva_contrase√±a_segura"}'
```

## Soporte

Para m√°s informaci√≥n:
- [Documentaci√≥n de Railway](https://docs.railway.app/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Node-postgres Documentation](https://node-postgres.com/)
